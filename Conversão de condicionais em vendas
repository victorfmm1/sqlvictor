SELECT
    vd.vendedor,                         -- Código do vendedor
    pp.nome,                             -- Nome do vendedor (parceiro)
    SUM(vd.dev_venda) as dev_venda,      -- Total de devoluções no período
    SUM(vd.total_venda) as total_venda,  -- Total de vendas no período
    SUM(vd.total_venda) - SUM(vd.dev_venda) as total_venda_liquido, -- Venda líquida = vendas - devoluções
    SUM(cd.vendida) as condicional_vendida,   -- Valor vendido de condicionais
    cd1.entregue as condiocional_entregue,    -- Valor entregue de condicionais
    cd.qtd,                                  -- Quantidade de condicionais vendidas
    cd1.qtd                                  -- Quantidade de condicionais entregues

FROM

    -- Subselect principal das vendas e devoluções do período
    (SELECT
            v.vendedor,
            SUM(iif(v.tipo_nd = 'D', v.total_venda, 0)) as dev_venda,   -- Soma devoluções
            SUM(iif(v.tipo_nd = 'N', v.total_venda, 0)) as total_venda  -- Soma vendas normais
        FROM vendas v
        WHERE
            v.dtacomp BETWEEN :pDataIni AND :pDataFim    -- Filtro por data
            AND v.idn_cancelada = 'N'                    -- Apenas notas não canceladas
            AND (v.vendedor = :Vendedor OR (:Vendedor = 0))  -- Filtra por vendedor, se informado
        GROUP BY
            v.vendedor) as vd

    -- Relaciona com tabela de parceiros para trazer nome do vendedor
    LEFT JOIN parceiros pp ON vd.vendedor = pp.parceiro

    -- Subselect das condicionais vendidas
    LEFT JOIN (
        SELECT
            c.vendedor,
            COUNT(DISTINCT c.numcondicional) as QTD,    -- Quantidade de condicionais diferentes
            SUM(c.valor) as VENDIDA                     -- Soma do valor vendido
        FROM condicionais c
            LEFT JOIN vendas_itens vdi ON vdi.condicional_id = c.condicional_id
        WHERE
            vdi.dtacomp BETWEEN :pDataIni AND :pDataFim  -- Data baseada no item de venda
        GROUP BY
            c.vendedor) as cd
        ON vd.vendedor = cd.vendedor

    -- Subselect das condicionais entregues no período
    LEFT JOIN (
        SELECT
            c.vendedor,
            COUNT(DISTINCT c.numcondicional) as QTD,   -- Quantidade de condicionais entregues
            SUM(c.valor) as ENTREGUE                   -- Valor total entregue
        FROM condicionais c
        WHERE
            c.dtacomp BETWEEN :pDataIni AND :pDataFim  -- Data da condicional
        GROUP BY
            c.vendedor) as cd1
        ON vd.vendedor = cd1.vendedor

-- Agregação final dos resultados
GROUP BY
    vd.vendedor,
    pp.nome,
    condiocional_entregue,
    cd.qtd,
    cd1.qtd;
