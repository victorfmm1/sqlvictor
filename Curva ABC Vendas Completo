-- Seleção final com classificação ABC e somatórios por classe
SELECT
    d3.codproduto,                   -- Código do produto + classe
    d3.descprod,                     -- Descrição do produto + classe
    d3.total_prod,                   -- Faturamento do produto
    d3.qtd,                          -- Quantidade vendida do produto
    d3.total_geral,                  -- Faturamento total de todos os produtos
    d3.perc,                         -- Participação % do produto no total
    d3.perc_acu,                     -- Participação acumulada
    d3.clase,                        -- Classe ABC (A, B ou C)

    -- Soma das QTD somente dos produtos classe A
    CASE
      WHEN d3.clase = 'A' THEN SUM(d3.qtd) OVER (PARTITION BY d3.clase = 'A')
      ELSE ''
    END AS soma_qtd_A,

    -- Soma do TOTAL somente dos produtos classe A
    CASE
      WHEN d3.clase = 'A' THEN SUM(d3.total_prod) OVER (PARTITION BY d3.clase = 'A')
      ELSE ''
    END soma_total_A,

    -- Classe B – quantidade
    CASE
      WHEN d3.clase = 'B' THEN SUM(d3.qtd) OVER (PARTITION BY d3.clase = 'B')
      ELSE ''
    END AS soma_qtd_B,

    -- Classe B – total
    CASE
      WHEN d3.clase = 'B' THEN SUM(d3.total_prod) OVER (PARTITION BY d3.clase = 'B')
      ELSE ''
    END soma_total_B,

    -- Classe C – quantidade
    CASE
      WHEN d3.clase = 'C' THEN SUM(d3.qtd) OVER (PARTITION BY d3.clase = 'C')
      ELSE ''
    END AS soma_qtd_C,

    -- Classe C – total
    CASE
      WHEN d3.clase = 'C' THEN SUM(d3.total_prod) OVER (PARTITION BY d3.clase = 'C')
      ELSE ''
    END soma_total_C,

    -- Contagem de itens por classe A/B/C
    CASE
      WHEN d3.clase = 'A' THEN COUNT(d3.codproduto) OVER (PARTITION BY d3.clase = 'A')
      ELSE ''
    END soma_itens_A,

    CASE
      WHEN d3.clase = 'B' THEN COUNT(d3.codproduto) OVER (PARTITION BY d3.clase = 'B')
      ELSE ''
    END soma_itens_B,

    CASE
      WHEN d3.clase = 'C' THEN COUNT(d3.codproduto) OVER (PARTITION BY d3.clase = 'C')
      ELSE ''
    END soma_itens_C


FROM (

    -- Define a classe ABC baseada no percentual acumulado
    SELECT
        d2.codproduto,
        d2.descprod,
        d2.total_prod,
        d2.qtd,
        d2.total_geral,
        d2.perc,
        d2.perc_acu,

        -- Regras ABC:
        -- A = até 80%
        -- B = entre 80% e 95%
        -- C = acima de 95%
        CASE
          WHEN d2.perc_acu <= 80 THEN 'A'
          WHEN d2.perc_acu <= 95 THEN 'B'
          ELSE 'C'
        END AS clase

    FROM (

        -- Calcula percentual acumulado
        SELECT
           d1.codproduto,
           d1.descprod,
           d1.total_prod,
           d1.qtd,
           d1.total_geral,
           d1.perc,

           -- Percentual acumulado ordenado por participação
           SUM(d1.perc) OVER (ORDER BY d1.perc DESC) AS perc_acu

        FROM (

            -- Calcula participação percentual de cada produto
            SELECT
             d.codproduto,
             d.descprod,
             d.total_prod,
             d.qtd,

             -- Soma geral das vendas (denominador do percentual)
             SUM(d.total_prod) OVER() AS total_geral,

             -- Percentual do produto sobre o total
             CAST(d.total_prod AS NUMERIC (15,3)) /
             CAST(SUM(d.total_prod) OVER() AS NUMERIC (15,3)) * 100 AS perc

            FROM (

                -- Agregação base: total vendido por produto
                SELECT
                    vi.codproduto || '/' || vi.codproduto_clas AS codproduto,
                    p.dscproduto || '/' || pc.dscproduto_clas AS descprod,
                    SUM(vi.total) AS total_prod,   -- Faturamento
                    SUM(vi.qtd) AS qtd             -- Quantidade vendida

                FROM
                    vendas_itens vi
                    LEFT JOIN vendas v ON v.venda_id = vi.venda_id
                    LEFT JOIN produtos p ON vi.codproduto = p.codproduto
                    LEFT JOIN produtos_clas pc ON vi.codproduto = pc.codproduto
                         AND vi.codproduto_clas = pc.codproduto_clas
                    LEFT JOIN filiais f ON v.codfilial = f.codfilial

                WHERE
                    vi.dtacomp BETWEEN :DataIni AND :DataFim   -- Período
                    AND (f.codfilial = :filial OR :filial = 0) -- Filial opcional
                    AND v.idn_cancelada = 'N'                  -- Somente vendas válidas
                    AND v.tipo_nd = 'N'                        -- Apenas notas normais

                GROUP BY 1,2
                ORDER BY 3 DESC
            ) d
        ) d1
    ) d2
) d3

ORDER BY d3.total_prod DESC; -- Ordena do maior para o menor faturamento
